package main

import (
	"context"
	"encoding/json"
	"fmt"
	"log"
	"time"

	mqtt "github.com/eclipse/paho.mqtt.golang"
	"github.com/go-redis/redis/v8"
)

var (
	rdb *redis.Client
	ctx = context.Background()
)

type DeviceMessage struct {
	DeviceID    string  `json:"device_id"`
	Token       string  `json:"token"`
	Temperature float64 `json:"temperature"`
	Pressure    float64 `json:"pressure"`
	Timestamp   int64   `json:"timestamp"`
}

// ---------- åˆå§‹åŒ– Redis ----------
func InitRedis() {
	rdb = redis.NewClient(&redis.Options{
		Addr:     "localhost:6379",
		Password: "",
		DB:       0,
	})
	_, err := rdb.Ping(ctx).Result()
	if err != nil {
		log.Fatal("Redis è¿æ¥å¤±è´¥:", err)
	}
	fmt.Println("âœ… Redis è¿æ¥æˆåŠŸ")
}

// ---------- éªŒè¯ token ----------
func validateToken(deviceID, token string) bool {
	var dbToken string
	err := db.QueryRow("SELECT token FROM devices WHERE device_id=?", deviceID).Scan(&dbToken)
	if err != nil {
		log.Println("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥:", err)
		return false
	}
	return dbToken == token
}

// ---------- MQTT æ¶ˆæ¯å›è°ƒ ----------
func messageHandler(client mqtt.Client, msg mqtt.Message) {
	var payload DeviceMessage
	err := json.Unmarshal(msg.Payload(), &payload)
	if err != nil {
		log.Println("âŒ JSON è§£æå¤±è´¥:", err)
		return
	}

	if !validateToken(payload.DeviceID, payload.Token) {
		log.Println("âŒ éæ³•è®¾å¤‡æ¶ˆæ¯ï¼Œä¸¢å¼ƒ:", payload.DeviceID)
		return
	}

	// å…¥åº“ MySQL
	_, err = db.Exec("INSERT INTO device_data (device_id, temperature, pressure, timestamp) VALUES (?, ?, ?, ?)",
		payload.DeviceID, payload.Temperature, payload.Pressure, payload.Timestamp)
	if err != nil {
		log.Println("âŒ MySQL æ’å…¥å¤±è´¥:", err)
	}

	// æ›´æ–° Redis åœ¨çº¿çŠ¶æ€
	rdb.Set(ctx, fmt.Sprintf("online:%s", payload.DeviceID), 1, 10*time.Second)

	// è°ƒç”¨ Python AI
	anomaly, err := detectAnomaly(payload.Temperature, payload.Pressure)
	if err != nil {
		log.Println("âŒ è°ƒç”¨ AI å¤±è´¥:", err)
	} else if anomaly {
		log.Printf("ğŸš¨ å¼‚å¸¸å‘Šè­¦ï¼è®¾å¤‡=%s æ¸©åº¦=%.2f å‹åŠ›=%.2f",
			payload.DeviceID, payload.Temperature, payload.Pressure)
	} else {
		log.Printf("âœ… è®¾å¤‡æ•°æ®æ­£å¸¸: %s", payload.DeviceID)
	}
}

// ---------- main å‡½æ•° ----------
func main() {
	// åˆå§‹åŒ– MySQL
	InitDB()

	// åˆå§‹åŒ– Redis
	InitRedis()

	// å¯åŠ¨ HTTP API
	go startHTTPServer()

	// MQTT å®¢æˆ·ç«¯
	opts := mqtt.NewClientOptions()
	opts.AddBroker("tcp://localhost:1883")
	opts.SetClientID("go_server")
	client := mqtt.NewClient(opts)

	if token := client.Connect(); token.Wait() && token.Error() != nil {
		log.Fatal("MQTT è¿æ¥å¤±è´¥:", token.Error())
	}
	fmt.Println("âœ… MQTT è¿æ¥æˆåŠŸ")

	// è®¢é˜… topic
	if token := client.Subscribe("devices/+/data", 0, messageHandler); token.Wait() && token.Error() != nil {
		log.Fatal("è®¢é˜…å¤±è´¥:", token.Error())
	}
	fmt.Println("ğŸ“¡ å·²è®¢é˜… topic: devices/+/data")

	select {} // é˜»å¡ä¸»çº¿ç¨‹
}
