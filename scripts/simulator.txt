import time
import json
import random
import requests
import paho.mqtt.client as mqtt

# ---------- é…ç½® ----------
MQTT_BROKER = "localhost"
MQTT_PORT = 1883
SEND_INTERVAL = 2  # ç§’
TOPIC_TEMPLATE = "devices/{}/data"
API_REGISTER_URL = "http://localhost:8080/devices/register"

# ---------- è·å–è®¾å¤‡ token ----------
try:
    resp = requests.post(API_REGISTER_URL)
    resp.raise_for_status()
except Exception as e:
    print("âŒ è®¾å¤‡æ³¨å†Œå¤±è´¥:", e)
    exit(1)

data = resp.json()
DEVICE_ID = data["device_id"]
TOKEN = data["token"]
print(f"âœ… å·²æ³¨å†Œè®¾å¤‡: {DEVICE_ID}, token: {TOKEN}")

# ---------- MQTT å®¢æˆ·ç«¯ ----------
client = mqtt.Client(client_id=DEVICE_ID)

def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print("ğŸŒ MQTT è¿æ¥æˆåŠŸ")
    else:
        print("âŒ MQTT è¿æ¥å¤±è´¥, è¿”å›ç :", rc)

client.on_connect = on_connect

client.connect(MQTT_BROKER, MQTT_PORT, 60)
client.loop_start()

# ---------- å‘¨æœŸå‘é€æ¶ˆæ¯ ----------
try:
    while True:
        payload = {
            "device_id": DEVICE_ID,
            "token": TOKEN,
            "temperature": round(random.uniform(20, 30), 2),
            "pressure": round(random.uniform(1.0, 1.5), 2),
            "timestamp": int(time.time())
        }
        client.publish(TOPIC_TEMPLATE.format(DEVICE_ID), json.dumps(payload))
        print("ğŸ“¤ å‘é€æ¶ˆæ¯:", payload)
        time.sleep(SEND_INTERVAL)
except KeyboardInterrupt:
    print("â¹ æ¨¡æ‹Ÿå™¨åœæ­¢")
    client.loop_stop()
    client.disconnect()

